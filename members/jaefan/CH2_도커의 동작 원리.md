# CH2. 도커의 동작 원리 
---

## SECTION 01. 도커의 동작 원리 
---

일반적으로 도커와 컨테이너는 `서버(물리적 서버)`에서 사용된다. 

도커를 사용하는 경우에는 `OS위에 도커 엔진이 동작하고 그 위에서 컨테이너가 동작`한다.

container  
docker-engine  
operating system 

운영체제(OS)는 자원을 효율적으로 관리하고, 사용자(SW 혹은 프로그램)와 HW간의 인터페이스를 제공한다.

운영체제는 크게 `커널(kernel)`과 그 외 `주변 부분`으로 구성된다. (이 주변 부분을 `유저 스페이스(user space)`라고 부르는 것 같다.)

도커 엔진 위에서 실행되는 컨테이너에는 `user space`가 들어있으며, host system의 `kernel`을 공유한다.

이때, host OS는 `Linux`가 기본이다. (Windows나 macOS의 경우에는 추가적인 `Docker Desktop`과 같은 추가적인 패키지 필요)

컨테이너 내부에 존재하는 user space가 컨테이너 속 프로그램의 명령을 전달 받아 host OS의 kernel에 전달하는 구조로 동작한다.

이렇듯, host system의 kernel을 공유 혹은 빌려 쓰는 형태 덕분에 컨테이너의 최대 장점인 `가벼움`을 얻을 수 있다.

도커는 기본적으로 `Linux` 에서만 동작한다. (설계 자체가 리눅스 기반으로 되어 있음)

따라서, 기본적으로 컨테이너 내부에 존재하는 user space도 `Linux의 user space`이어야 하고,  
컨테이너 내부에서 동작하는 SW / 프로그램도 `Linux 버전`이어야 한다.

위에서 언급했다 싶이, Windows나 macOS에서 도커를 사용하기 위해서는 `추가적인 패키지` 사용이 필요하다.

추가적인 패키지 사용 -> `어떻게든 Linux를 사용`하게 만든다.


## SECTION 02. 도커 허브와 이미지, 그리고 컨테이너 
---
### [이미지와 컨테이너]

컨테이너를 생성하기 위해서는 이미지가 있어야 한다. 

이미지는 컨테이너의 설계도 역할을 한다. (class of container)

```py
# 컨테이너가 클래스라면... 
class Container()
  def __init__(self, linux_version...):
    ...
```

클래스와 마찬가지로 이미지만 있다면, 동일한 컨테이너를 여러 개 만들어서 운용할 수 있다.

클래스-객체 관계와 다른 점이 있다면, `컨테이너를 이용한 이미지 생성`이 가능하다는 점이다.

따라서, 동일한 환경이 여러 개 필요한 경우에 기반이 되는 컨테이너를 하나 생성한 뒤 이미지를 추출해서 다른 컨테이너를 생성하면 된다.

물론, 도커 엔진만 존재한다면 어느 시스템에서든 해당 컨테이너를 운용할 수 있다.

### [도커 허브와 도커 이미지]

그래서 도커 이미지는 어디서 구하는데? -> `도커 허브`

도커 허브는 `공식`적으로 운영되는 도커 레지스트리이다.

도커 허브에는 공개된 컨테이너 이미지가 상당히 매우 많이 모여 있다.

> **그럼 어떤 이미지를 선택해야 하는데?**
> 1. 직접 컨테이너 구성을 수정하고 싶다. -> 간단한 이미지 (Linux 배포판 들어있는 정도)
> 2. 편리하게 사용하고 싶다. -> 설정이 완료되고, 필요한 SW가 포함된 이미지 (ex. Apache, MySQL)

원하는 이미지를 정확하게 선택해서 컨테이너를 운용해야 나중에 할 일이 줄어든다.

도커 허브는 공식적으로 운영되는 레지스트리이지만, 누구나 자유롭게 이미지를 등록할 수 있기 때문에 주의가 필요하다.

> **안전한 이미지 고르기**
> 1. 공식 이미지 사용 
> 2. 커스텀 이미지를 직접 만들어서 사용 

도커를 사용할 때 원칙 중 하나로, `'하나의 컨테이너에 하나의 프로그램'` 이라는 암묵적인 규칙이 존재한다.  
-> 보안 및 유지 관리 측면에서 매우 유리하기 때문.

하지만 권장되는 원칙이지, 무조건 지켜야하는 규칙은 아니니 상황에 맞추어 컨테이너 환경을 구축하면 될 것 같다.


## SECTION 03. 도커 컨테이너의 생애주기와 데이터 저장
---

### [도커 컨테이너는 '쓰고 버리는' 일회용품]

`도커 컨테이너는 '쓰고 버리는' 일회용품`

컨테이너는 일반적으로 여러 개를 동시에 가동하는 상황을 전제로 하기 때문에,  
여러 개의 컨테이너를 유지보수 하는 것보다 새로운 이미지로 새로운 컨테이너를 만들어 갈아 타는 것이 훨씬 경제적이다.

때문에 도커의 생애주기는 다음과 같이 표현되며, 해당 생애주기를 반복한다.

컨테이너를 만들고 -> 실행하고 -> 종료하고 -> 폐기한다.

### [데이터 저장]

컨테이너를 폐기하면 당연히 컨테이너 안에서 편집했던 데이터는 사라진다.

따라서, 보통의 경우 도커가 설치된 물리적 서버(host)의 디스크를 마운트해서 이 디스크에 데이터를 저장하고 관리한다.

> **마운트 (Mount)**  
> 디스크를 연결 해 데이터를 기록할 수 있도록 한 상태 

마운트 된 디스크에 데이터를 저장할 경우, 데이터를 사용하고 관리하던 컨테이너를 폐기하더라도 데이터는 보존된다.


## SECTION 04. 도커의 장점과 단점 
---

### [도커의 구조와 성질 및 그 장단점]

도커의 성질 다이어그램  
<img src='./images/도커의 성질 다이어그램.JPEG' width='50%'>

#### 핵심 성질 

1. `독립된 환경` -> 여러 개의 컨테이너 운용 / 동일한 애플리케이션 여러 개 실행 

2. `이미지를 만들 수 있다.` -> 쉬운 컨테이너 구축 / 이동성이 좋다. (환경 이동 / 개발환경 구축 용이)

3. `컨테이너에 '커널'을 포함 시킬 필요가 없다.` -> 가볍다.

### [도커의 장점과 단점]

#### 도커의 장점 

1. `한 대의 물리 서버에 여러 대의 기능적 서버를 띄울 수 있다.`

2. `서버 관리가 용이하다.`

3. `서버 고수가 아니어도 다루기 쉽다.`

#### 도커의 단점 

1. `Only Linux`
 
2. `단일 장애 지점 (Single Point of Failure)`  
하나의 물리 서버에 여러 대의 기능적 서버가 올라가있는 형태이므로,  
물리 서버(host)에 문제가 생길 경우 모든 컨테이너(기능적 서버)에 영향을 미친다.  
따라서, 물리 서버에 대한 확실한 관리가 필요하다.

3. `도커 엔진의 오버헤드`  
도커를 구동하기 위해서는 도커 엔진이 필수적인데,  
컨테이너를 극소수로 사용하는 경우 도커 엔진이 단순한 오버헤드에 지나지 않는다.


### [도커의 주 용도]

#### 동일한 개발 환경 제공 

- 팀원 모두에게 동일한 개발환경 제공이 가능하다.  

- 프로젝트 별로 컨테이너를 따로 사용할 수 있다.

#### 새로운 버전의 테스트 

- 새로운 버전을 배포 하기 전 테스트 환경으로도 적합하다. 

#### 동일한 서버가 여러 대 필요한 경우 

- 동일한 서버가 여러 대 필요한 경우, 한 대의 물리 서버에 똑같은 서버를 여러 개 만들 수 있다. (비용 절감)